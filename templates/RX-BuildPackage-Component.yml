spec:
  inputs:
    stage:
      default: RX-BuildPackage
    rules:
      default: '"true" == "true"'
---
RX-BuildPackage-Component:
  tags:
    - $RunnerTags
  stage: $[[ inputs.stage ]]
  rules: 
    - if: $[[ inputs.rules ]]
  before_script:
    # Очистка папки пакета
    - Remove-Item -Path "$PackageProjectPath\*" -Recurse -Force
  script:
    # Переопределение путей с учетом веток. При изменении логики также поменять в BuildPackage, PreparedServer, DeployDTPackage, UploadPackage и VersionUp компонентах
    - $FormattedBranchName = ($CI_COMMIT_BRANCH -replace '\W', '_')
    - $GitProjectFolder = "$GitProjectFolder\$FormattedBranchName"
    #- $PackageProjectPath = "$PackageProjectPath\$FormattedBranchName"
    # Generate Package.xml
    - if ($BuildMode -eq "Release") { & "${AutoGenPackageUtilPath}\PackageXmlGenerator.exe" -p $GitProjectFolder -o $PackageProjectPath -l $SolutionList -a } else {echo "not Release" }
    - if ($BuildMode -eq "DebugRelease") { & "${AutoGenPackageUtilPath}\PackageXmlGenerator.exe" -p $GitProjectFolder -o $PackageProjectPath -l $SolutionList -a -d } else {echo "not DebugRelease" }
    - if ($BuildMode -eq "Source") { & "${AutoGenPackageUtilPath}\PackageXmlGenerator.exe" -p $GitProjectFolder -o $PackageProjectPath -l $SolutionList -a -d -s } else {echo "not Source" }
    - if ($BuildMode -eq "SourceBase") { & "${AutoGenPackageUtilPath}\PackageXmlGenerator.exe" -p $GitProjectFolder -o $PackageProjectPath -l $SolutionList -a -d -s -m } else {echo "not SourceBase" }
    - if ($BuildMode -eq "OnlySourceBase") { & "${AutoGenPackageUtilPath}\PackageXmlGenerator.exe" -p $GitProjectFolder -o $PackageProjectPath -l $SolutionList -s -m } else {echo "not OnlySourceBase" }
    - if ( Test-Path $PackageProjectPath\packageGen.xml ) { } else { echo "Not created packageGen.xml"; exit 1}
    # Build
    - $process = Start-Process -FilePath "$DDSConfigPath\DevelopmentStudio.exe" -ArgumentList "-c $PackageProjectPath\packageGen.xml -d $PackageProjectPath\$($FormattedBranchName)_package.dat --increment-version false" -PassThru
    - $process.WaitForExit()
    - if ( Test-Path "$PackageProjectPath\$($FormattedBranchName)_package.dat" ) { } else { echo "Not created $($FormattedBranchName)_package.dat"; exit 1}
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - ./*
    exclude:
      - ./*packageGen*